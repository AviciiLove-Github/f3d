import os
import json
import numpy as np
from scipy.spatial import KDTree

def nearest_distances_kdtree(A, B):
    tree = KDTree(B)
    distances, _ = tree.query(A)  # distances是每个A中点到B最近点的距离
    return distances

def Compare(point):
    folder_path = "./static/models/triggerpoint"
    # point = [{'x': 0.6954441038365367, 'y': 1.7080183895216299, 'z': 2.388340282636868}, {'x': 0.6273015454392047, 'y': 1.6756346031391611, 'z': 2.367243554891657}, {'x': 0.7666658178321417, 'y': 1.6273646160378927, 'z': 2.4200269562666694}, {'x': 0.6424300010135338, 'y': 1.6113715052208266, 'z': 2.3725025972298206}, {'x': 0.7328399705393374, 'y': 1.6455442530875146, 'z': 2.41657931506046}, {'x': 0.8280496915997255, 'y': 1.546611886466308, 'z': 2.384279765012532}, {'x': 0.656733259702526, 'y': 1.7452413218920497, 'z': 2.4138186094753586}, {'x': 0.7422517659563087, 'y': 1.6290169901814402, 'z': 2.3487128267936384}, {'x': 0.8671022508930066, 'y': 1.5368121355963105, 'z': 2.4732225745815852}, {'x': 0.9569404208510455, 'y': 1.4408142221729547, 'z': 2.4585552449095633}, {'x': 0.9164163694991198, 'y': 1.5374174361936324, 'z': 2.53342791373632}, {'x': 0.8751534945762713, 'y': 1.528373901723348, 'z': 2.4152935306111853}, {'x': 0.9505177382102066, 'y': 1.4893160092089133, 'z': 2.4925502076450354}, {'x': 0.9202161012260965, 'y': 1.58284491466392, 'z': 2.4690690486807076}, {'x': 1.0431615658810574, 'y': 1.5268649548991693, 'z': 2.439293135423244}, {'x': 0.9478742257151516, 'y': 1.447445315891981, 'z': 2.5467248204502497}, {'x': 1.003015888179052, 'y': 1.4723603429616254, 'z': 2.4750354748156256}, {'x': 0.9521281825220231, 'y': 1.5718317240275983, 'z': 2.460791101327961}, {'x': 0.9711451228280414, 'y': 1.5712669459174122, 'z': 2.4446726289106513}, {'x': 0.9229167506024133, 'y': 1.5439575980936864, 'z': 2.4484719167524718}, {'x': 1.0172782605834358, 'y': 1.4896479591420437, 'z': 2.4332064049813233}, {'x': 1.0014226690320895, 'y': 1.4311243208187752, 'z': 2.3722644092413745}, {'x': 1.073545218292837, 'y': 1.5135819619123294, 'z': 2.505750110467508}, {'x': 0.9713765936926185, 'y': 1.56034190254502, 'z': 2.4825589346647}, {'x': 0.9950631286149995, 'y': 1.553295756040768, 'z': 2.3450232291552164}, {'x': 1.0095528472261777, 'y': 1.6000684917606538, 'z': 2.4286606727244218}, {'x': 0.9729180519536978, 'y': 1.5048453350600932, 'z': 2.3900327374887067}, {'x': 1.0921332683788307, 'y': 1.5532118344071908, 'z': 2.3778532329783073}, {'x': 0.9526518766503658, 'y': 1.5848482538323623, 'z': 2.3175179339557777}, {'x': 1.0114778513544365, 'y': 1.5056240476177676, 'z': 2.2770111089173946}, {'x': 0.8994957708707557, 'y': 1.6212443742743838, 'z': 2.253064730734951}, {'x': 0.9291940765994955, 'y': 1.5582144098924906, 'z': 2.3315737982751736}, {'x': 0.929350799998221, 'y': 1.6023240275974189, 'z': 2.297444797780375}, {'x': 0.8895424834794725, 'y': 1.559281960997668, 'z': 2.345121640525523}, {'x': 1.021459024505321, 'y': 1.6616956170843058, 'z': 2.394993467709556}, {'x': 0.9824082431049524, 'y': 1.6261830709367058, 'z': 2.2386389843122108}, {'x': 0.952221705380769, 'y': 1.6021302917604494, 'z': 2.274910664954878}, {'x': 0.9985377707682969, 'y': 1.6427199077767571, 'z': 2.317998141409832}, {'x': 0.8890002567395056, 'y': 1.5473418957387104, 'z': 2.2018910699085166}, {'x': 0.9582137004064145, 'y': 1.5775737194714465, 'z': 2.3397270018289813}, {'x': 1.185200352402871, 'y': 1.4914557889511144, 'z': 2.183278375391263}, {'x': 1.1603961569155508, 'y': 1.5806647491245716, 'z': 2.210303674255812}, {'x': 1.101187152627888, 'y': 1.5428493890791861, 'z': 2.1170321041218374}, {'x': 1.157087052268611, 'y': 1.4670607407870535, 'z': 2.2166954950372766}, {'x': 1.3235777407605844, 'y': 1.4218398204714369, 'z': 2.2219283408737933}, {'x': 1.410467393142115, 'y': 1.4593350757141328, 'z': 2.1771126581043228}, {'x': 1.3029654146718783, 'y': 1.364170551953035, 'z': 2.2758452860601963}, {'x': 1.2971091789073788, 'y': 1.3724946743307067, 'z': 2.186143435933537}, {'x': 1.377532055474399, 'y': 1.38298617126706, 'z': 2.263661917859695}, {'x': 1.3531630913261712, 'y': 1.3944237339730536, 'z': 2.3409332851451037}, {'x': 1.3798802057925796, 'y': 1.3573518425536997, 'z': 2.3144646759360894}, {'x': 1.3124174226433714, 'y': 1.4389027486728876, 'z': 2.25910689673756}, {'x': 1.444698626668756, 'y': 1.3395119716362416, 'z': 2.3346620645417984}, {'x': 1.3484753614829794, 'y': 1.3019285586674383, 'z': 2.4271015190925516}, {'x': 1.3521933523773109, 'y': 1.2423300943589206, 'z': 2.391458228117858}, {'x': 1.3648769809590378, 'y': 1.4319738565374478, 'z': 2.3473128523477724}, {'x': 1.4412321577970741, 'y': 1.3035626682924395, 'z': 2.4316952056591603}, {'x': 1.4166162874482844, 'y': 1.3500439289735455, 'z': 2.4737625291779604}, {'x': 1.4121808697102924, 'y': 1.2252563404632382, 'z': 2.4168286194361936}, {'x': 1.4224336327516256, 'y': 1.2357576420146676, 'z': 2.3982541653637113}, {'x': 1.3462276070095576, 'y': 1.2930495017861467, 'z': 2.5121604239231625}, {'x': 1.417513921465018, 'y': 1.3155307551527353, 'z': 2.5170675720206392}, {'x': 1.405330036983925, 'y': 1.3143255427168816, 'z': 2.560097720044969}, {'x': 1.2506574126355505, 'y': 1.240638492550471, 'z': 2.5908290151113698}, {'x': 1.0974138210302595, 'y': 1.3317937050071507, 'z': 2.6226979121403273}, {'x': 1.0676378412574659, 'y': 1.248566596046068, 'z': 2.6641327479292842}, {'x': 1.0182491203407267, 'y': 1.2725681443792711, 'z': 2.6426796949335314}, {'x': 1.0079093750363277, 'y': 1.3336711330242972, 'z': 2.549214818961863}, {'x': 1.0255722784267913, 'y': 1.369403318531294, 'z': 2.605318225746525}, {'x': 1.033565174914092, 'y': 1.454028251192489, 'z': 2.584682430524647}, {'x': 1.0333590328069056, 'y': 1.4094696799023356, 'z': 2.6578303225029005}, {'x': 1.0617064908293083, 'y': 1.3180414389131498, 'z': 2.581491053071083}, {'x': 0.9939110079345433, 'y': 1.4296893283370586, 'z': 2.5410501188938555}, {'x': 1.031798714115805, 'y': 1.4282474582982576, 'z': 2.5794810599441402}, {'x': 0.9591579698645266, 'y': 1.469722921639917, 'z': 2.466759026766347}, {'x': 1.0002132473327783, 'y': 1.4566070529083253, 'z': 2.5559989810588606}, {'x': 1.0446089906517741, 'y': 1.4828236680520241, 'z': 2.4203198351490927}, {'x': 1.0911490108650077, 'y': 1.4373154535455233, 'z': 2.384028395283502}, {'x': 1.1143527818191459, 'y': 1.5665472392848379, 'z': 2.4476670796045696}, {'x': 1.043407862770942, 'y': 1.5052692571226962, 'z': 2.380668958324572}, {'x': 1.1259072075585588, 'y': 1.4809273759023363, 'z': 2.3602142236627284}, {'x': 1.0309987633333446, 'y': 1.3893547475300403, 'z': 2.3538196581490114}, {'x': 1.1873895991184482, 'y': 1.407989319408629, 'z': 2.4261360362080278}, {'x': 1.0565871754232363, 'y': 1.5392236415030855, 'z': 2.321997051897748}, {'x': 1.2143467601516473, 'y': 1.4229720446747613, 'z': 2.3715573352638017}, {'x': 1.2004147722430991, 'y': 1.415002463756401, 'z': 2.4202596622106562}, {'x': 1.3015501997727204, 'y': 1.507224670104111, 'z': 2.3318416944002225}, {'x': 1.225332434916896, 'y': 1.370267567914125, 'z': 2.441687598091128}, {'x': 1.3158483826428105, 'y': 1.3539226870463992, 'z': 2.4406832800054716}, {'x': 1.2983532600913947, 'y': 1.4374130401039116, 'z': 2.439182291749057}, {'x': 1.2527995048339748, 'y': 1.4007525766458098, 'z': 2.414372664292395}, {'x': 1.3537572386297236, 'y': 1.416044824060895, 'z': 2.4055670407455767}, {'x': 1.2919456722657083, 'y': 1.3049121254049378, 'z': 2.589036328729185}, {'x': 1.3705972851286299, 'y': 1.3902027368288044, 'z': 2.5416342399033343}, {'x': 1.192122924782533, 'y': 1.2368363535762272, 'z': 2.673431159648727}, {'x': 1.3344072388655623, 'y': 1.2801225656580746, 'z': 2.5495744682379207}, {'x': 1.1408225817120345, 'y': 1.278692360096997, 'z': 2.680625730389703}, {'x': 1.1998681790821384, 'y': 1.2447149310509973, 'z': 2.7658035678944026}, {'x': 1.0735037448215512, 'y': 1.2922741489010123, 'z': 2.7619147193456666}, {'x': 1.06992535258524, 'y': 1.330919827666867, 'z': 2.672005529658118}, {'x': 1.0652567922440297, 'y': 1.2690950335230937, 'z': 2.716085385834021}, {'x': 1.1484040177593933, 'y': 1.2808579113142908, 'z': 2.6741776505924264}, {'x': 0.9908992511584747, 'y': 1.1881355908358184, 'z': 2.6420125503918497}, {'x': 1.0091554680971795, 'y': 1.3252595014440471, 'z': 2.677427474837189}, {'x': 1.0398166018643131, 'y': 1.2666258964173451, 'z': 2.7307124466283073}, {'x': 1.0319740499477543, 'y': 1.361634774677517, 'z': 2.7501732935318564}, {'x': 0.9659566010447672, 'y': 1.329902629870323, 'z': 2.815007030503337}, {'x': 1.1123662357709854, 'y': 1.3229774113379147, 'z': 2.64661210489195}, {'x': 0.9714897620893315, 'y': 1.2590271768925128, 'z': 2.7665841301459055}, {'x': 1.0292138190557016, 'y': 1.221073234192783, 'z': 2.8023636580249027}, {'x': 1.0118313544799156, 'y': 1.2164632699078768, 'z': 2.769704849959587}, {'x': 1.0453653912023964, 'y': 1.2248537854269226, 'z': 2.8354692496735683}, {'x': 0.7186335601734906, 'y': 1.2466640000895133, 'z': 2.837242259755803}, {'x': 0.7632807703417518, 'y': 1.3141957705325813, 'z': 2.822332849628176}, {'x': 0.7426025329853492, 'y': 1.233224582515049, 'z': 2.922549216870716}, {'x': 0.7459410955527659, 'y': 1.3389634380377533, 'z': 2.9164898701895754}]
    p_arr = np.array([[pt['x'], pt['y'], pt['z']] for pt in point])
    file_dict = {}
    out = []
    
    for filename in os.listdir(folder_path):
        file_path = os.path.join(folder_path, filename)
        try:
            with open(file_path, "r", encoding="utf-8") as f:
                file_data = json.load(f)
                file_arr = np.array([[pt['x'], pt['y'], pt['z']] for pt in file_data])
        except Exception as e:
            print(f"读取 {filename} 出错: {e}")
        
        dist = nearest_distances_kdtree(p_arr, file_arr)
        
        count_2 = np.sum(dist < 1)
        if count_2 >= 0.2*len(p_arr):
            out.append(filename[:-5])
        
        file_dict[filename] = dist.mean()
    
    
    
    if out == []:
        min_key = min(file_dict, key=file_dict.get)
        find = '，暂未找到对应的触发点'
        out.append(min_key[:-5])
    else:
        find = ''
        with open('./static/models/triggerpoint.json', 'w', encoding='utf-8') as f:
            f.write(json.dumps(out, ensure_ascii=False))

    
    overall = "、".join(out)
    result = '\n\n另外，若使用触发点疗法%s。\n推荐治疗%s。\n相关注意事项可查看《无痛一身轻》一书。' % (find,overall)
    
    with open('Temp-C', 'w', encoding='utf-8') as f:
        f.write(result)
